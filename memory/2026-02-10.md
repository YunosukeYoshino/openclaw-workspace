# 2026-02-10 Memory

## Sandbox Browser Setup

### Problem
ヘッドレスブラウザでスクリーンショット撮影時に `libnspr4.so` 等のシステムライブラリ不足エラーが発生していた。

**原因**: WSL2 環境にはブラウザの依存ライブラリがデフォルトで入っておらず、ホスト側で直接 Chromium を起動しようとしていた。

### Solution
openclaw には既に Docker コンテナ内でブラウザを動かす仕組み (sandbox browser) があったが、デフォルトでは無効だった。これを有効化した。

### Actions Taken

#### 1. Docker イメージのビルド
```bash
scripts/sandbox-browser-setup.sh
```

結果: `openclaw-sandbox-browser:bookworm-slim` (1.46GB) を作成

#### 2. openclaw.json で sandbox browser を有効化
ファイル: `~/.openclaw/openclaw.json`

設定変更:
```json
{
  "agents": {
    "defaults": {
      "sandbox": {
        "browser": {
          "enabled": true,
          "headless": true,
          "autoStart": true
        }
      }
    }
  }
}
```

#### 3. TOOLS.md を更新
ファイル: `~/.openclaw/workspace/TOOLS.md`

変更内容:
- 古い Python Playwright の手動記述を削除
- sandbox browser (Docker コンテナ内 Chromium) の使い方・注意事項に置き換え
- ブラウザ自動化には MCP Playwright ツールを使用することを明記
- Docker コンテナ内で実行されるため、WSL2 ホスト側のライブラリ不足問題を回避できることを記載

### Benefits
- WSL2 環境でもブラウザ依存ライブラリをインストールせずにヘッドレスブラウザが使用可能
- Docker コンテナ内で隔離されるため、セキュリティと安定性が向上
- 他の環境でも同じ設定で動作する移植性の高いセットアップ

### Related Files
- Docker イメージビルドスクリプト: `scripts/sandbox-browser-setup.sh`
- 設定ファイル: `~/.openclaw/openclaw.json`
- ワークスペースドキュメント: `~/.openclaw/workspace/TOOLS.md`

---

## Sandbox Browser 動作確認

### Test Results
sandbox browser の Docker コンテナでスクショ撮影テストを実施し、成功を確認した。

**テスト手順:**
1. `docker run` で `openclaw-sandbox-browser:bookworm-slim` コンテナを手動起動 (ポートマッピング 19222:9222)
2. CDP HTTP API (`/json/version`) で Chromium 144 (headless) の起動を確認
3. CDP WebSocket 経由で `example.com` に navigate し、`Page.captureScreenshot` でスクショ取得成功 (16KB PNG)

**発見した注意点:**
- Playwright の `connectOverCDP()` は socat 経由の WebSocket 接続でタイムアウトする場合がある (Bun 環境)
- CDP WebSocket に直接接続する方法 (`ws://127.0.0.1:PORT/devtools/page/ID`) なら問題なく動作
- Chrome 144+ では `/json/new` エンドポイントに PUT メソッドが必要 (GET は非推奨)
- コンテナ内の dbus エラーは無害 (headless 環境では正常)

**結論:**
- sandbox browser は正常動作。ホスト側に Chromium 依存ライブラリは不要
- 実運用時はエージェントの `browser` ツール経由で自動起動・接続される
- Docker コンテナによる隔離環境でブラウザ自動化が安全に実行できることを確認
